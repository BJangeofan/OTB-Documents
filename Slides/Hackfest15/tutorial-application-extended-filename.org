#+TITLE: OTB Tips and tricks
#+AUTHOR: OTB development team
#+DATE: 3 - 5 june 2015, Toulouse
#+DESCRIPTION: 
#+KEYWORDS: 
#+LANGUAGE:  en
#+OPTIONS:   H:2 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+INFOJS_OPT: view:nil toc:nil ltoc:nil mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+LINK_UP:   
#+LINK_HOME: 

#+startup: oddeven

#+startup: beamer
#+LaTeX_CLASS: beamer
#+LaTeX_CLASS_OPTIONS: [8pt]

#+latex_header: \usepackage{etex}
#+latex_header: \mode<presentation>{\usetheme{Vilanova}}
#+latex_header: \usepackage[english]{babel}
#+latex_header: \usepackage[utf8]{inputenc}
#+latex_header: \usepackage{array}
#+latex_header: \usepackage{chronology}
#+latex_header: \let\CHRONOLOGY\chronology
#+latex_header: \let\endCHRONOLOGY\endchronology
#+latex_header: \def\chronology{\shorthandoff{;}\CHRONOLOGY}
#+latex_header: \def\endchronology{\endCHRONOLOGY\shorthandon{;}}
#+latex_header: \usepackage{pstricks}
#+latex_header: \usepackage{graphicx}
#+latex_header: \usepackage{booktabs}
#+latex_header: \usepackage{amsmath,amssymb,amsthm}
#+latex_header: \usepackage{xcolor}
#+latex_header: \usepackage{textpos}
#+latex_header: \usepackage{tikz}
#+latex_header: \usepackage{xmpincl}
#+latex_header: \usetikzlibrary{arrows}
#+latex_header: \usepackage{pifont}
#+latex_header: \usepackage{listings,color}
#+latex_header: \definecolor{listcomment}{rgb}{0.0,0.5,0.0}
#+latex_header: \definecolor{listkeyword}{rgb}{0.0,0.0,0.5}
#+latex_header: \definecolor{listnumbers}{gray}{0.65}
#+latex_header: \definecolor{listlightgray}{gray}{0.955}
#+latex_header: \definecolor{listwhite}{gray}{1.0}
#+latex_header: \includexmp{images/cc}
#+latex_header: \subtitle{Welcome, agenda, useful information}
#+latex_header: \pgfdeclareimage[height=96mm,width=128mm]{background}{images/fondsClairSansLogo}
#+latex_header: \pgfdeclareimage[height=0.2cm]{cc}{images/CC-licence.png}
#+latex_header: \setbeamertemplate{background}{\pgfuseimage{background}}
#+latex_header: \pgfdeclareimage[height=0.6cm]{logoIncrust}{images/logoIncrust}
#+latex_header: \logo{  \begin{tabular}{p{0.22\textwidth}p{0.58\textwidth}p{0.1\textwidth}p{0.1\textwidth}}   \href{http://creativecommons.org/licenses/by-sa/3.0/}{\pgfuseimage{cc}}    & \vspace{-0.03\textwidth} \scriptsize{}     &  & \href{http://www.orfeo-toolbox.org}{\pgfuseimage{logoIncrust}}\\\end{tabular} }


#+BEAMER_FRAME_LEVEL: 2

#+COLUMNS: %20ITEM %13BEAMER_env(Env) %6BEAMER_envargs(Args) %4BEAMER_col(Col) %7BEAMER_extra(Extra)


* Introduction

** Intro
- Explore the way that OTB read/write geometry information
- Explore the way that OTB stream the data
- See how you can modify otb behaviour using extended filename features
* Basic idea
** Goal
   - Goal : Orthorectification or NDVI computation  of a Pleiades image
   - Easy?
   - In a efficient way...
* Lets go
** NDVI of Pleiades dataset : the basic way
   - otbcli_BandMath -il IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -exp "ndvi(im1b1,im1b4)" -out ndvi.tif
** Orthorectification: the basic way
   - otbcli_OrthoRectification -io.in IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -io.out ortho.tif  
** Pixel encoding (storage)
   - Input image is encoded on 16 bits
   - By default output is written in float in OTB-Applications
   - To write in unsigned int : otbcli_OrthoRectification -io.in
     IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.JP2 -io.out ortho.tif uint16
   - Save Space
   - Not time...
   - Can save more space using jpeg in tiff
** Dynamic range != Storage
   - Dynamic range 12 bits and storage 16 bits for most HR sensors
   - Tif format support 12 bits/pixel
   - How to do this in OTB? Using extended filename mechanism : https://www.orfeo-toolbox.org/SoftwareGuide/SoftwareGuidech6.html#x26-950006.10
   - otbcli_OrthoRectification -io.in
     IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.JP2 -io.out
     "ortho.tif?&gdal:co:NBITS=12" uint16

** Writing large file Part 1 (easy mode)
   - Ram parameter in OTB Applications: Available memory for processing (in MB)
   - Gdal got some caching capabilities. Writing large image file with OTB, it is
     a good idea to extend size of this cache: export GDAL_CACHEMAX=256
   - Combination of streaming mode and internal file encoding  mode (tile/strip)

** Writing large file Part 2
   - See http://wiki.orfeo-toolbox.org/index.php/Writing_large_images
   - You can manage the way that OTB streamed the data:
   - "ortho.tif?&gdal:co:NBITS=12&streaming:type=tiled"
   - You can also manage the size of streaming pieces computation
   - "ortho.tif?&gdal:co:NBITS=12&streaming:type=tiled&streaming:sizevalue=2048" 
   - Never do tiled streaming and write stripped GeoTiff (default mode)
   - "ortho.tif?&gdal:co:NBITS=12&streaming:type=tiled&streaming:sizevalue=2048&gdal:co:TILED=yes"

** Write only a subset of the output
   - Method 1 : write the entire image and ExtractROI (facepalm)
   - Method 2 : use the extendedfilename box
   - &box=<startx>:<starty>:<sizex>:<sizey>
   -
     "ortho.tif?&gdal:co:NBITS=12&gdal:co:TILED=yes&streaming:type=tiled&streaming:sizevalue=2048&box=1000:1000:512:512"

** ExtractROI basic
   - time otbcli_ExtractROI -in
     IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -out extract.tif
     -startx 1000 -starty 1000 -sizex 5000 -sizey 5000
   - real	0m7.851s

** ExtractROI with right pixel type
   - time otbcli_ExtractROI -in  IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -out extract.tif uint16 -startx 1000 -starty 1000 -sizex 5000 -sizey 5000
   - real	0m5.010s

** ExtractROI with 12 bits output pixel
   - time otbcli_ExtractROI -in  IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -out "extract.tif?&gdal:co:NBITS=12" uint16 -startx 1000 -starty 1000 -sizex 5000 -sizey 5000
   - real	0m26.768s
   - why?

** ExtractROI and tiled output with input in tile format
   - time otbcli_ExtractROI -in  IMG_PHR1A_MS_201202250025599_SEN_PRG_FC_5847-002_R1C1.TIF -out "extract.tif?&gdal:co:TILED=yes" uint16 -startx 1000 -starty 1000 -sizex 5000 -sizey 5000
   - real	0m2.997s
