\section{Stereo reconstruction}
\ifitkFullVersion
\label{sec:StereoReconstruction}
\fi

This section deals with the standard problem of terrain reconstruction 
from an image pair. The images are assumed to come from the same sensor 
but with different positions. The approach presented here has the 
following steps:
\begin{itemize}
\item Epipolar resampling of the image pair
\item Dense disparity map estimation
\item Projection of the disparities on a DEM
\end{itemize}
It is important to note that this method requires the sensor models with
a pose estimate for each image.

\subsection{Epipolar resampling}
The image pair is supposed to be in sensor geometry. From two images covering
nearly the same area, one can estimate a common epipolar geometry. In this geometry, 
an altitude variation corresponds to an horizontal shift between the two images.
The filter \doxygen{otb}{StereorectificationDeformationFieldSource} computes the 
deformation grids for each image.

These grids are sampled in epipolar geometry. They have two bands, containing the 
position offset (in physical space units) between the current epipolar point and the 
corresponding sensor point. They can be computed at a lower resolution than sensor
resolution. The application \code{StereoRectificationGridGenerator} provides a 
simple tool to generate the epipolar grids for your image pair.

Then, the sensor images can be resampled in epipolar geometry, using the 
\doxygen{otb}{StreamingWarpImageFilter}. The application 
\code{GridBasedImageResampling} gives an easy access to this filter. The user
can choose the epipolar region to resample, as well as the resampling step.

\subsection{Disparity map estimation}
Once the two sensor images have been resampled in epipolar geometry, the 
disparity map can be computed. The approach presented here is a 2D matching 
based on a pixel-wise metric optimization. This approach is doesn't give the best 
results compared to global optimization methods, but it is suitable for 
streaming and threading on large images. 

The major filter used for this step is \doxygen{otb}{PixelWiseBlockMatchingImageFilter}.
The metric is computed on a window centered around the tested epipolar position. 
It performs a pixel-to-pixel matching between the two epipolar images. The output disparities
are given as index offset from left to right position. The following features are available 
in this filter:
\begin{itemize}
\item Available metrics : SSD, NCC and $L^{p}$ pseudo norm (computed on a square window)
\item Rectangular disparity exploration area.
\item Input masks for left and right images (optional).
\item Output metric values (optional).
\item Possibility to use input disparity estimate (as a uniform value or a full map) and an exploration radius around 
these values to reduce the size of the exploration area (optional).
\end{itemize}

Some other filters have been added to enhance these pixel-to-pixel disparities. The filter
\doxygen{otb}{SubPixelDisparityImageFilter} can estimate the disparities with sub-pixel 
precision. Several interpolation methods can be used : parabollic fit, triangular fit, and 
dichotomy search.

The filter \doxygen{otb}{DisparityMapMedianFilter} can be used to remove outliers.

The filter \doxygen{otb}{AdhesionCorrectionFilter} can be used to detect and rectify
adhesion effects (i.e. when disparity regions corresponding to high object tend to be larger than their real area).

The application \code{PixelWiseBlockMatching} contain all these filters and 
provide a single interface to compute your disparity maps.

\subsection{Projection on a DEM}
The disparity map obtained  with the previous step usually gives a good idea of 
the altitude profile. However, it is more usefull to study altitude with a DEM (Digital 
Elevation Model) representation. 

The filter \doxygen{otb}{DisparityMapToDEMFilter} performs this last step. The behaviour
of this filter is to :
\begin{itemize}
\item Compute the DEM extent from the left sensor image envelope (spacing is set by the user)
\item Compute the left and right rays corresponding to each valid disparity
\item Compute the intersection with the "mid-point" method
\item If the 3D point falls inside a DEM cell and has a greater elevation than the 
current height, the cell height is updated
\end{itemize}
The rule of keeping the highest elevation makes sense for buildings seen from the side 
because the roof edges elevation has to be kept. However this rule is not suited for 
noisy disparities. 

The application \code{DisparityMapToElevationMap} gives an example of use.

