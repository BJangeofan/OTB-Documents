\newpage
\section{SAR polarimetry applications}\label{sec:polarimetry}
%add intro
This section describes how to use the applications related to SAR polarimetry.

\subsection{Matrices conversions}\label{ssec:polconv}

This applications allows converting classical polarimetric matrices to each other.
For instance, it is possible to get the coherency matrix from the Sinclar one, or the Mueller matrix from the coherency one.
The figure below (\ref{fig:polconv}) shows the workflow used in this application.

\begin{figure}[h]
  \centering
   \includegraphics[width=\textwidth]{../Art/sarpol_conversion_schema.png}
  \itkcaption[SAR polarimetry conversion]{SAR polarimetry conversion application.}
  \label{fig:polconv}
\end{figure}

The filters used in this application never handle matrices, but images where each band is related to their elements.
As most of the time SAR polarimetry handles symetric matrices, only the relevant elements are stored, so that the images representing them have a minimal number of bands.
For instance, the coherency matrix size is 3x3 in the monostatic case, and 4x4 in the bistatic case : it will thus be stored in a 6-band or a 10-band complex image (the diagonal and the upper elements of the matrix).

The Sinclair matrix is a special case : it is always represented as 3 or 4 one-band complex images (for mono- or bistatic case).

There are 13 available conversions, each one being related to the following  parameters:
\begin{enumerate}
\item msinclairtocoherency
\item msinclairtocovariance
\item msinclairtocircovariance
\item mcoherencytomueller
\item mcovariancetocoherencydegree
\item mcovariancetocoherency
\item mlinearcovariancetocircularcovariance
\item muellertomcovariance
\item bsinclairtocoherency
\item bsinclairtocovariance
\item bsinclairtocircovariance
\item sinclairtomueller
\item muellertopoldegandpower
\end{enumerate}

For each option parameter, the list below gives the formula used.

\subsubsection{--- Monostatic case ---}

\begin{enumerate}
\renewcommand{\labelenumii}{Channel \arabic{enumii} : }
\item msinclairtocoherency (SinclairToReciprocalCoherencyMatrixFunctor)
\begin{enumerate}
\item $ 0.5 . (S_{hh}+S_{vv}).(S_{hh}+S_{vv})^{*} $
\item $ 0.5 . (S_{hh}+S_{vv}).(S_{hh}-S_{vv})^{*} $
\item $ 0.5 . (S_{hh}+S_{vv}).(2 S_{hv})^{*} $
\item $ 0.5 . (S_{hh}-S_{vv}).(S_{hh}-S_{vv})^{*} $
\item $ 0.5 . (S_{hh}-S_{vv}).(2 S_{hv})^{*} $
\item $ 0.5 . (2 S_{hv}).(2 S_{hv})^{*} $
\end{enumerate}
 
\item msinclairtocovariance (SinclairToReciprocalCovarianceMatrixFunctor)
\begin{enumerate}
\item $ S_{hh}.S_{hh}^{*} $ 
\item $ \sqrt{2}.S_{hh}.S_{hv}^{*} $ 
\item $ S_{hh}.S_{vv}^{*} $ 
\item $ 2.S_{hv}.S_{hv}^{*} $ 
\item $ \sqrt{2}.S_{hv}.S_{vv}^{*} $ 
\item $ S_{vv}.S_{vv}^{*} $
\end{enumerate}
 
\item msinclairtocircovariance (SinclairToReciprocalCircularCovarianceMatrixFunctor)
\begin{enumerate}
\item $ S_{ll}.S_{ll}^{*} $ 
\item $ S_{ll}.S_{lr}^{*} $ 
\item $ S_{ll}.S_{rr}^{*} $ 
\item $ S_{lr}.S_{lr}^{*} $ 
\item $ S_{lr}.S_{rr}^{*} $ 
\item $ S_{rr}.S_{rr}^{*} $
\end{enumerate}
 
\item mcoherencytomueller (ReciprocalCoherencyToReciprocalMuellerFunctor)
\begin{enumerate}
\item $ 0.5*( C_{11}+C_{22}+C_{33} ) $ 
\item $ Re(C_{12}) + Im(C_{22}) $ 
\item $ Re(C_{13}) $ 
\item $ Im(C_{23}) $ 
\item $ Re(C_{12}) $ 
\item $ 0.5*( C_{11}+C_{22}-C_{33} ) $ 
\item $ Re(C_{23}) $ 
\item $ Im(C_{13}) $ 
\item $ -Re(C_{13}) $ 
\item $ -Re(C_{23}) $
\item $ 0.5.Re(VAL1) $
\item $ 0.5.Im(VAL0) $
\item $ Im(C_{23}) $
\item $ Im(C_{13}) $
\item $ 0.5.Im(VAL1^{*}) $
\item $ 0.5.Re(VAL0) $
\end{enumerate}

With:
\begin{itemize} 
\item $ VAL0 = C_{33}+C_{12}-C_{11}-(C_{12}-C_{22})^{*}  $ 
\item $ VAL1 = -C_{33}+C_{12}-C_{11}-(C_{12}-C_{22})^{*} $ 
\end{itemize}

Where Cij are related to the elements of the reciprocal coherence matrix.
 
 
\item mcovariancetocoherencydegree (ReciprocalCovarianceToCoherencyDegreeFunctor)
\begin{enumerate}
\item $ abs(S_{hh}.S_{vv}^{*}) / sqrt(S_{hh}.S_{hh}^{*}) / sqrt(S_{vv}.S_{vv}^{*}) $ 
\item $ abs(S_{hv}.S_{vv}^{*}) / sqrt(S_{hv}.S_{hv}^{*}) / sqrt(S_{vv}.S_{vv}^{*}) $ 
\item $ abs(S_{hh}.S_{hv}^{*}) / sqrt(S_{hh}.S_{hh}^{*}) / sqrt(S_{hv}.S_{hv}^{*}) $
\end{enumerate}
 
\item mcovariancetocoherency (ReciprocalCovarianceToReciprocalCoherencyFunctor)
\begin{enumerate}
\item $ 0.5 . ( C_{33} + C_{13} + C_{13}^{*} + C_{11} ) $ 
\item $ 0.5 . ( -C_{33} - C_{13} + C_{13}^{*} + C_{11} ) $ 
\item $ 0.5 . ( \sqrt{2}.C_{12} + \sqrt{2}.C_{23}^{*} ) $ 
\item $ 0.5 . ( C_{33} - C_{13} - C_{13}^{*} + C_{11} ) $ 
\item $ 0.5 . ( \sqrt{2}.C_{12} - \sqrt{2}.C_{23}^{*} ) $ 
\item $ 0.5 . ( 2 . C_{22} ) $
\end{enumerate}

Where Cij are related to the elements of the reciprocal linear covariance matrix.
 
\item mlinearcovariancetocircularcovariance (ReciprocalLinearCovarianceToReciprocalCircularCovarianceFunctor)
\begin{enumerate}
\item $ 0.25 . ( C_{33}-i.\sqrt{2}.C_{23}-C_{13}+i.\sqrt{2}.C_{23}^{*}-C_{13}^{*}+2.C_{22}-i.\sqrt{2}.C_{12}+i.\sqrt{2}.C_{12}^{*}+C_{11} ) $ 
\item $ 0.25 . ( i.\sqrt{2}.C_{33}+2.C_{23}-i.\sqrt{2}.C_{13}+i.\sqrt{2}.C_{13}^{*}+2.C_{12}^{*}-i.\sqrt{2}.C_{11} ) $ 
\item $ 0.25 . ( -C_{33}+i.\sqrt{2}.C_{23}+C_{13}+i.\sqrt{2}.C_{23}^{*}+C_{13}^{*}+2.C_{22}-i.\sqrt{2}.C_{12}-i.\sqrt{2}.C_{12}^{*}-C_{11} ) $ 
\item $ 0.25 . ( 2.C_{33}+2.C_{13}+2.C_{13}^{*}+2.C_{11} ) $ 
\item $ 0.25 . ( i.\sqrt{2}.C_{33}+i.\sqrt{2}.C_{13}+2.C_{23}^{*}-i.\sqrt{2}.C_{13}^{*}+2.C_{12}-i.\sqrt{2}.C_{11} ) $ 
\item $ 0.25 . ( C_{33}+i.\sqrt{2}.C_{23}-C_{13}-i.\sqrt{2}.C_{23}^{*}-C_{13}^{*}+2.C_{22}+i.\sqrt{2}.C_{12}-i.\sqrt{2}.C_{12}^{*}+C_{11} ) $
\end{enumerate}

Where Cij are related to the elements of the reciprocal linear covariance matrix.

\item muellertomcovariance (MuellerToReciprocalCovarianceFunctor)
\begin{enumerate}
\item $ 0.5.(M_{11}+M_{22}+2.M_{12}) $ 
\item $ 0.5.\sqrt{2}.[(M_{13}+M_{23}) + j.(M_{14}+M_{24})] $ 
\item $ -0.5.(M_{33}+M_{44}) - j.M_{34} $ 
\item $ M_{11}-M_{22} $ 
\item $ 0.5.\sqrt{2}.[(M_{13}-M_{23}) + j.(M_{14}-M_{24})] $ 
\item $ 0.5.(M_{11}+M_{22}-2.M_{12}) $
\end{enumerate}

\end{enumerate}

\subsubsection{--- Bistatic case ---}

\begin{enumerate}
\renewcommand{\labelenumii}{Channel \arabic{enumii} : }
\setcounter{enumi}{7}

\item bsinclairtocoherency (SinclairToCoherencyMatrixFunctor)
\begin{enumerate}
\item $ (S_{hh}+S_{vv}).(S_{hh}+S_{vv})^{*} $ 
\item $ (S_{hh}+S_{vv}).(S_{hh}-S_{vv})^{*} $ 
\item $ (S_{hh}+S_{vv}).(S_{hv}+S_{vh})^{*} $ 
\item $ (S_{hh}+S_{vv}).( j (S_{hv}-S_{vh}))^{*} $ 
\item $ (S_{hh}-S_{vv}).(S_{hh}-S_{vv})^{*} $ 
\item $ (S_{hh}-S_{vv}).(S_{hv}+S_{vh})^{*} $ 
\item $ (S_{hh}-S_{vv}).( j (S_{hv}-S_{vh}))^{*} $ 
\item $ (S_{hv}+S_{vh}).(S_{hv}+S_{vh})^{*} $ 
\item $ (S_{hv}+S_{vh}).( j (S_{hv}-S_{vh}))^{*} $ 
\item $ j (S_{hv}-S_{vh}).( j (S_{hv}-S_{vh}))^{*} $
\end{enumerate}
 
\item bsinclairtocovariance (SinclairToCovarianceMatrixFunctor)
\begin{enumerate}
\item $ S_{hh}.S_{hh}^{*} $ 
\item $ S_{hh}.S_{hv}^{*} $ 
\item $ S_{hh}.S_{vh}^{*} $ 
\item $ S_{hh}.S_{vv}^{*} $ 
\item $ S_{hv}.S_{hv}^{*} $ 
\item $ S_{hv}.S_{vh}^{*} $ 
\item $ S_{hv}.S_{vv}^{*} $ 
\item $ S_{vh}.S_{vh}^{*} $ 
\item $ S_{vh}.S_{vv}^{*} $ 
\item $ S_{vv}.S_{vv}^{*} $
\end{enumerate}
 
\item bsinclairtocircovariance (SinclairToCircularCovarianceMatrixFunctor)
\begin{enumerate}
\item $ S_{ll}.S_{ll}^{*} $ 
\item $ S_{ll}.S_{lr}^{*} $ 
\item $ S_{ll}.S_{rl}^{*} $ 
\item $ S_{ll}.S_{rr}^{*} $ 
\item $ S_{lr}.S_{lr}^{*} $ 
\item $ S_{lr}.S_{rl}^{*} $ 
\item $ S_{lr}.S_{rr}^{*} $ 
\item $ S_{rl}.S_{rl}^{*} $ 
\item $ S_{rl}.S_{rr}^{*} $ 
\item $ S_{rr}.S_{rr}^{*} $ 
\end{enumerate}

With:
\begin{itemize} 
\item $ S_{ll} = 0.5(-S_{hh}-j S_{hv}-j S_{vh}+S_{vv}) $ 
\item $ S_{lr} = 0.5(-S_{hh}+j S_{hv}-j S_{vh}+S_{vv}) $ 
\item $ S_{rl} = 0.5(-S_{hh}-j S_{hv}+j S_{vh}-S_{vv}) $ 
\item $ S_{rr} = 0.5(-S_{hh}+j S_{hv}+j S_{vh}+S_{vv}) $ 
\end{itemize}
 


\subsubsection{--- Both cases ---}

\item sinclairtomueller (SinclairToMueller)
\begin{enumerate} 
\item $ 0.5 Re( T_{xx}.T_{xx}^{*} + T_{xy}.T_{xy}^{*} + T_{yx}.T_{yx}^{*} + T_{yy}.T_{yy}^{*} ) $ 
\item $ 0.5 Re( T_{xx}.T_{xx}^{*} - T_{xy}.T_{xy}^{*} + T_{yx}.T_{yx}^{*} - T_{yy}.T_{yy}^{*} ) $ 
\item $ Re( T_{xx}.T_{xy}^{*} + T_{yx}.T_{yy}^{*} ) $ 
\item $ Im( T_{xx}.T_{xy}^{*} + T_{yx}.T_{yy}^{*} ) $ 
\item $ 0.5 Re( T_{xx}.T_{xx}^{*} + T_{xy}.T_{xy}^{*} - T_{yx}.T_{yx}^{*} - T_{yy}.T_{yy}^{*} ) $ 
\item $ 0.5 Re( T_{xx}.T_{xx}^{*} - T_{xy}.T_{xy}^{*} - T_{yx}.T_{yx}^{*} + T_{yy}.T_{yy}^{*} ) $ 
\item $ Re( T_{xx}.T_{xy}^{*} - T_{yx}.T_{yy}^{*} ) $ 
\item $ Im( T_{xx}.T_{xy}^{*} - T_{yx}.T_{yy}^{*} ) $ 
\item $ Re( T_{xx}.T_{yx}^{*} + T_{xy}.T_{yy}^{*} ) $ 
\item $ Im( T_{xx}.T_{yx}^{*} - T_{xy}.T_{yy}^{*} ) $ 
\item $ Re( T_{xx}.T_{yy}^{*} + T_{xy}.T_{yx}^{*} ) $ 
\item $ Im( T_{xx}.T_{yy}^{*} - T_{xy}.T_{yx}^{*} ) $ 
\item $ Re( T_{xx}.T_{yx}^{*} + T_{xy}.T_{yy}^{*} ) $ 
\item $ Im( T_{xx}.T_{yx}^{*} - T_{xy}.T_{yy}^{*} ) $ 
\item $ Re( T_{xx}.T_{yy}^{*} + T_{xy}.T_{yx}^{*} ) $ 
\item $ Im( T_{xx}.T_{yy}^{*} - T_{xy}.T_{yx}^{*} ) $
\end{enumerate}

With :
\begin{itemize}
\item $ T_{xx} = -S_{hh} $ 
\item $ T_{xy} = -S_{hv} $ 
\item $ T_{yx} = S_{vh} $ 
\item $ T_{yy} = S_{vv} $ 
\end{itemize}

 
\item muellertopoldegandpower (MuellerToPolarisationDegreeAndPowerFunctor)
\begin{enumerate}
\item $ P_{min} $ 
\item $ P_{max} $ 
\item $ DegP_{min} $ 
\item $ DegP_{max} $
\end{enumerate}

\end{enumerate}

Examples :

\begin{enumerate}
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invv imageryC_VV.tif
									  -conv msinclairtocoherency -outc coherency.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invv imageryC_VV.tif
									  -conv msinclairtocovariance -outc covariance.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invv imageryC_VV.tif
									  -conv msinclairtocircovariance -outc circ_covariance.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inc coherency.tif 
									  -conv mcoherencytomueller -outf mueller.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inc covariance.tif 
									  -conv mcovariancetocoherencydegree -outc coherency_degree.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inc covariance.tif 
									  -conv mcovariancetocoherency -outc coherency.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inc covariance.tif 
									  -conv mlinearcovariancetocircularcovariance -outc circ_covariance.tif \end{verbatim}	
									  			
\item \begin{verbatim} otbcli_SARConvert -inf mueller.tif 
									  -conv muellertomcovariance -outc covariance.tif \end{verbatim}	
									  								  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invh imageryC_VH.tif -invv imageryC_VV.tif
									  -conv bsinclairtocoherency -outc bcoherency.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invh imageryC_VH.tif -invv imageryC_VV.tif 
									  -conv bsinclairtocovariance -outc bcovariance.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invh imageryC_VH.tif -invv imageryC_VV.tif
									  -conv bsinclairtocircovariance -outc circ_bcovariance.tif \end{verbatim}
									  
									  
\item \begin{verbatim} otbcli_SARConvert -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invh imageryC_VH.tif -invv imageryC_VV.tif 
									  -conv sinclairtomueller -outf mueller.tif \end{verbatim}
									  
\item \begin{verbatim} otbcli_SARConvert -inf mueller.tif 
									  -conv muellertopoldegandpower -outf degreepower.tif \end{verbatim}
									  
\end{enumerate}

\subsection{Polarimetric decompositions}\label{ssec:poldecomp}

From one-band complex images (HH, HV, VH, VV), returns the selected decomposition.
The H-alpha-A decomposition is currently the only one available; it is implemented for the monostatic case (transmitter and receiver are co-located).
User must provide three one-band complex images HH, HV or VH, and VV (HV = VH in monostatic case).
The applications returns a float vector image, made of three channels : H (entropy), Alpha, A (Anisotropy).

In order to do so, the complex coherency matrix (size 3*3) must be diagonalized.
The H-alpha-A decomposition thus uses the following filters : SinclairToReciprocalCoherencyMatrixFunctor and ReciprocalHAlphaImageFilter.
Here are the formula used (refer to the previous section about how the covariance matrix is obtained from the sinclair one):
\begin{enumerate}
\renewcommand{\labelenumi}{Channel \arabic{enumi} : }
\item $ entropy = -\sum_{i=0}^{2} \frac{p[i].\log{p[i]}}{\log{3}} $
\item $ \alpha = \sum_{i=0}^{2} p[i].\alpha_{i} $
\item $ anisotropy = \frac {SortedEigenValues[1] - SortedEigenValues[2]}{SortedEigenValues[1] + SortedEigenValues[2]} $
\end{enumerate}

Where:
\begin{itemize}
\item $ p[i] = max(SortedEigenValues[i], 0) / \sum_{i=0}^{2, SortedEigenValues[i]>0} SortedEigenValues[i] $
\item $ \alpha_{i} = \left| SortedEigenVector[i] \right|* \frac{180}{\pi}$
\end{itemize}

With:
\begin{itemize}
\item $ \text{if} p[i] < 0, p[i]=0 $
\item $ \text{if} p[i] > 1, p[i]=1 $
\item $ \text{if} \alpha_{i} > 90, \alpha_{i}=90 $
\end{itemize}

Example :

\begin{verbatim} otbcli_SARDecompositions -inhh imageryC_HH.tif -inhv imageryC_HV.tif -invv imageryC_VV.tif
									  -decomp haa -out HaA.tif \end{verbatim}


\subsection{Polarimetric synthetis}\label{ssec:polsynth}

This application gives, for each pixel, the power that would have been received by a SAR system with a basis different from the classical (H,V) one (polarimetric synthetis). 
The new basis are indicated through two Jones vectors, defined by the user thanks to orientation (psi) and ellipticity (khi) parameters.
These parameters are namely psii, khii, psir and khir. The suffixes (i) and (r) refer to the transmiting antenna and the receiving antenna respectively.
Orientations and ellipticities are given in degrees, and are between -90/90 degrees and -45/45 degrees respectively. 

Four polarization architectures can be processed :
\begin{enumerate}
\item HH\_HV\_VH\_VV : full polarization, general bistatic case.
\item HH\_HV\_VV or HH\_VH\_VV : full polarization, monostatic case (transmitter and receiver are co-located).
\item HH\_HV : dual polarization.
\item VH\_VV : dual polarization.
\end{enumerate}
The application takes a complex vector image as input, where each band correspond to a particular emission/reception polarization scheme.
User must comply with the band order given above, since the bands are used to build the Sinclair matrix.

In order to determine the architecture, the application first relies on the number of bands of the input image.
\begin{enumerate}
\item Architecture HH\_HV\_VH\_VV is the only one with four bands, there is no possible confusion.
\item Concerning HH\_HV\_VV and HH\_VH\_VV architectures, both correspond to a three channels image. But they are processed in the same way, as the Sinclair matrix is symetric in the monostatic case.
\item Finally, the two last architectures (dual polarizations), can't be distinguished only by the number of bands of the input image. User must then use the parameters emissionh and emissionv to indicate the architecture of the system : emissionh=1 and emissionv=0 for HH\_HV,  emissionh=0 and emissionv=1 for VH\_VV.
\end{enumerate}
Note : if the architecture is HH\_HV, khii and psii are automatically set to 0/0 degrees; if the architecture is VH\_VV, khii and psii are automatically set to 0/90 degrees.

It is also possible to force the calculation to co-polar or cross-polar modes.
In the co-polar case, values for psir and khir will be ignored and forced to psii and khii; same as the cross-polar mode, where khir and psir will be forced to psii + 90 degrees and -khii.

Finally, the result of the polarimetric synthetis is expressed in the power domain, through a one-band scalar image. \newline


 
The final formula is thus : \begin{verbatim} P = | B^T . [S] . A |^2 \end{verbatim} , where A ans B are two Jones vectors and S is a Sinclair matrix.
 
The two figures below (\ref{fig:polsynthll} and \ref{fig:polsynthlr}) show the two images obtained with the basis LL and LR (L for left circular polarization and R for right polarization),
from a Radarsat 2 image taken over Vancouver. Once the four two-band images imagery\_HH imagery\_HV imagery\_VH imagery\_VV were merged 
into a single four complex band image imageryC\_HH\_HV\_VH\_VV.tif, the following commands were used to produce the LL and LR images :

\begin{verbatim} otbcli_SARPolarSynth -in imageryC_HH_HV_VH_VV.tif 
									  -psii 0 -khii 45 -mode co -out test-LL.tif \end{verbatim}
\begin{verbatim} otbcli_SARPolarSynth -in imageryC_HH_HV_VH_VV.tif 
									  -psii 0 -khii 45 -mode cross -out test-LR.tif \end{verbatim}

The produced images were then rescaled to intensities ranging from 0 to 255 in order to be displayed.


\begin{center}
  \begin{figure}[h]
    \includegraphics[width=\textwidth]{../Art/test-left-co-2.png}
    \itkcaption[SAR polarimetry conversion]{Image LL}
    \label{fig:polsynthll}
   \end{figure}
   
   \begin{figure}[h]
    \includegraphics[width=\textwidth]{../Art/test-left-cross-2.png}
    \itkcaption[SAR polarimetry conversion]{Image LR}
    \label{fig:polsynthlr}
   \end{figure}
\end{center}
