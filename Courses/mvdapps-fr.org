** *Monteverdi* et *OTB applications*                               :mvdapps:
*** Description
**** Résumé

Cet exercice permet de se familiariser avec l'utilisation
de *Monteverdi* et les outils disponibles dans *OTB Applications*.

**** Pré-requis

- Connaissances de base en télédétection et traitement des images
- Être capable de lancer des programmes en ligne de commande

**** Objectifs

- Visualisation de données dans *Monteverdi*
- Traitements simples avec *Monteverdi*
- Traitements simples avec *OTB Applications* en mode graphique
- Traitements simples avec *OTB Applications* en ligne de commande

*** \'Etapes

**** Monteverdi: data opening and visualisation
Dans cette partie de l'exercice, l'image suivante sera utilisée :
~phr_pxs_melbourne.tif~

1. Lancement de *Monteverdi* : ouvrir un terminal et tapper
   : $ monteverdi    
2. Ouvrir l'image (avec le menu /File/Open dataset/)
3. Trouver une façon d'afficher l'image (il y a 2 façons de faire).
4. Se déplacer dans l'image :
   1. Changer la zone affichée à pleine résolution;
   2. Changer la zone affichée dans la fenêtre de zoom;
   3. Changer le niveau de zoom;
   4. Quelles sont les informations affichées à propos du pixel qui se
      trouve sous le pointeur de la souris?
5. \`A l'aide paneau de configuration de la visualisation dans
   l'onglet /Setup/ :
   1. Changer la configuration pour visualiser la 4ème bande;
   2. Affichage en fausses couleurs (mettre le proche infra-rouge dans
      l'affichage rouge, la bande rouge dans l'affichage vert et la
      bande verte dans l'affichage bleu);
   3. Changer la configuration pour revenir à un affichage en couleurs naturelles;
   4. Améliorer le contraste en utilisant la zonne à pleine résolution;
   5. Améliorer le contraste en utilisant la zonne de zoom;
   6. Revenir aux ajustements de contraste par défaut.
        
_Tucs et astuces:_
 - Les flèches du clavier peuvent être utilisées pour naviguer dans les images.
 - L'ordre des bandes Pléiades est : rouge, vert, bleu et proche infra-rouge.

**** Monteverdi : traitements basiques
#+LABEL:   ex1_monteverdi_basic_processing
Dans cette partie l'image suivante est utilisée :

~phr_xs_melbourne.tif~

1. Ouvrez l'image dans *Monteverdi*.
2. Trouvez le module /BandMath/ dans les menus. Ouvrez l'image dans ce
   module. Quel type de traitement est proposé?
3. \`A l'aide de ce module, calculez le NDVI de l'image :
   #+LATEX:\begin{equation}
   NDVI = \frac{PIR-Rouge}{PIR+Rouge}
   #+LATEX:\end{equation}
4. En utilisant le même module, créez un masque des pixels dont la
   valeur dans le PIR est inférieure à 150. Affichez l'image et le
   masque dans le même /viewer/
5. Créez un masque correspondant aux pixels dont la valeur est
   supérieure à 1000 dans toutes les bandes spectrales. Visualisez le
   masque et l'image dans le même /viewer/.
6. Utilisez le module /Concatenate/ afin de créer une image RVB
   composite avec le masque des valeurs élevées dans le rouge, le
   masque des valeurs faibles de PIR dans le bleu et le NDVI dans le
   vert.
7. Utilisez le module /Color Mapping/ afin de créer une image
   composite RVB du NDVI qui permet une meilleure interprétation
   visuelle.

_Trucs et astuces :_
- Les valeurs du NDVI sont comprises entre -1 et +1, mais la vraie
  dynamique des valeurs observées peut être beaucoup plus faible.

**** OTB applications : mode graphique et ligne de commande
1. Lancez la commande suivante :
   : $ otbcli_OrthoRectification
   et ensuite
   : $ otbgui_OrthoRectification
   Qu'observez-vous?
2. Combien d'applications sont actuellement disponibles dans *OTB Applications*?
3. Comment peut-on obtenir de l'aide et de la documentation à propos
   des applications?

**** OTB applications : traitements simples
Utilisez les applications afin de reproduire les résultats des étapes
3 à 7 de la section sur Monteverdi [[Monteverdi : traitements basiques]].
     
**** Pour aller plus loin
1. Comment peut-on lire ou visualiser des images directement depuis la
   ligne de commande avec *Monteverdi*?
2. Y-t'il d'autres façons de calculer des indices comme le NDVI avec
   les *OTB Applications*?
3. Renseignez-vous sur l'utilisation des *OTB Applications* depuis
   /Python/ et écrivez un script en /Python/ qui réalise les mêmes
   traitements que dans la section [[OTB applications : traitements simples]]
     
*** Solutions                                                     :solutions:

**** Monteverdi: data opening and visualisation

***** Item 3

      To load an image into *Monteverdi* viewer module, you can either:
      - Right-click on the image and select /Display in viewer/,
      - In the menu bar, select /Visualization/Viewer/, select the
        corresponding image and push /Ok/.

      The latter allows to load multiple images into a single viewer.

***** Item 4
      
      The lower left text area displays information on the image and on
      the pixel under the mouse pointer:
      - The current position in image,
      - The image size,
      - The channel displayed,
      - The pixel values,
      - The estimated ground spacing,
      - The geographic position (if available),
      - The current location (if available).

**** Monteverdi: basic processing

***** Item 2

      The *BandMath* module allows to do advanced band calculations
      using the syntax from [[http://muparser.sourceforge.net/][muParser]] .

***** Item 3

      To compute the NDVI, use the following *BandMath* expression:
      : (im1b4-im1b1)/(im1b4+im1b1)

***** Item 4

      To build a mask of pixels whose DN in the NIR channel is lower
      than 150, use the following *BandMath* expression:
      : if(im1b4<150,255,0)

***** Item 5

      To build a mask of pixels whose DN is upper
      than 1000 in all spectral bands, use the following *BandMath*
      expression:
      : if(min(im1b1,im1b2,im1b3,im1b4)>1000,255,0)

***** Item 6

      In the menu bar, select /File/Concatenate images/, and loads the
      three *BandMath* module  outputs. The resulting image can be
      displayed in the viewer and will look like this:

      #+Latex:\vspace{0.5cm}
      #+Latex:\begin{center}
      #+ATTR_LaTeX: width=0.9\textwidth
      [[file:Images/bandmath.png]]
      #+Latex:\end{center}

***** Item 7

      In the menu bar, select /Visualisation/Color Mapping/ and load
      the NDVI output from the *BandMath* module. Set a mapping range
      from -0.2 to 0.7 so as to adapt to NDVI range, and select the /Jet/
      color map. The resulting image can be displayed in the viewer and
      will look like this:

      #+Latex:\vspace{0.5cm}
      #+Latex:\begin{center}
      #+ATTR_LaTeX: width=0.9\textwidth
      [[file:Images/colormapping.png]]
      #+Latex:\end{center}

**** OTB applications: Graphical and command-line mode

***** Item 1
      
      The first command runs the command-line version of the
      *Orthorectification* application, the second one runs the
      graphical version.
      
***** Item 2

      There are 59 applications available in OTB 3.14.1.

***** Item 3

      There are several ways to get help and documentation:
      - Running the command-line version of the application displays a
        short description of the parameters, and also gives a link to
        the documentation on the [[http://www.orfeo-toolbox.org][OTB website]],
      - Running the graphical version of the application shows a
        /Documentation/ tab where extensive documentation of parameters
        can be found.
      - Last, the complete applications documentation can be found in
        the [[http://www.orfeo-toolbox.org/CookBook/][Orfeo ToolBox Cookbook]].

**** OTB applications: Basic processing

***** Item 1
   
      Here is the set of commands to reproduce the processing from
      section [[Monteverdi: basic processing]].

      First, we compute the NDVI with the *BandMath* application:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out ndvi.tif float -exp "(im1b4-im1b1)/(im1b4+im1b1)"

      Then, we compute the mask of pixels whose DN in the NIR channel
      is lower than 150:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out lownir.tif uint8 -exp "if(im1b4<150,255,0)"

      Next, we compute the mask of pixels whose DN is upper
      than 1000 in all spectral bands:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out high.tif uint8 
      :   -exp "if(min(im1b1,im1b2,im1b3,im1b4)>1000,255,0)"

      Please note that for masks using a /uint8/ data type is enough,
      while for NDVI a floating point data type is needed.
      
      Now, we can concatenate all outputs in a single map with the
      *ConcatenateImages* application:

      : $ otbcli_ConcatenateImages -il high.tif ndvi.tif lownir.tif 
      :   -out map1.tif float

      Finally, we can create a color-mapping of the NDVI using the
      *ColorMapping* application:

      : $ otbcli_ColorMapping -in ndvi.tif -out map2.png uint8 
      :   -method continuous -method.continuous.min -0.2 
      :   -method.continuous.max 0.7 -method.continuous.lut jet

**** Homework
***** Item 1
      From the command-line, running 
      : $ monteverdi -in  phr_xs_melbourne.tif
      will open the image in *Monteverdi* and display it in the viewer,
      and
      : $ monteverdi -il  phr_xs_melbourne.tif ndvi.tif
      allows to open a list of images in *Monteverdi*.

***** Item 2
      In *OTB Applications*, there is a *RadiometricVegetationIndices*
      application that allows to compute several indices including the
      NDVI.

***** Item 3

      Please refer to this chapter of the *Cookbook* to learn more
      about the /Python/ [[http://www.orfeo-toolbox.org/CookBook/CookBooksu7.html#x16-170001.3.4][interface]].
     
