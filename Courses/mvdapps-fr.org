** *Monteverdi* et *OTB applications*                               :mvdapps:
*** Description
**** Résumé

Cet exercice permet de se familiariser avec l'utilisation
de *Monteverdi* et les outils disponibles dans *OTB Applications*.

**** Pré-requis

- Connaissances de base en télédétection et traitement des images
- Être capable de lancer des programmes en ligne de commande

**** Objectifs

- Visualisation de données dans *Monteverdi*
- Traitements simples avec *Monteverdi*
- Traitements simples avec *OTB Applications* en mode graphique
- Traitements simples avec *OTB Applications* en ligne de commande

*** \'Etapes

**** Monteverdi: data opening and visualisation
Dans cette partie de l'exercice, l'image suivante sera utilisée :
~phr_pxs_melbourne.tif~

1. Lancement de *Monteverdi* : ouvrir un terminal et tapper
   : $ monteverdi    
2. Ouvrir l'image (avec le menu /File/Open dataset/)
3. Trouver une façon d'afficher l'image (il y a 2 façons de faire).
4. Se déplacer dans l'image :
   1. Changer la zone affichée à pleine résolution;
   2. Changer la zone affichée dans la fenêtre de zoom;
   3. Changer le niveau de zoom;
   4. Quelles sont les informations affichées à propos du pixel qui se
      trouve sous le pointeur de la souris?
5. \`A l'aide paneau de configuration de la visualisation dans
   l'onglet /Setup/ :
   1. Changer la configuration pour visualiser la 4ème bande;
   2. Affichage en fausses couleurs (mettre le proche infra-rouge dans
      l'affichage rouge, la bande rouge dans l'affichage vert et la
      bande verte dans l'affichage bleu);
   3. Changer la configuration pour revenir à un affichage en couleurs naturelles;
   4. Améliorer le contraste en utilisant la zonne à pleine résolution;
   5. Améliorer le contraste en utilisant la zonne de zoom;
   6. Revenir aux ajustements de contraste par défaut.
        
_Tucs et astuces:_
 - Les flèches du clavier peuvent être utilisées pour naviguer dans les images.
 - L'ordre des bandes Pléiades est : rouge, vert, bleu et proche infra-rouge.

**** Monteverdi: basic processing
     #+LABEL:   ex1_monteverdi_basic_processing
     In this part of the exercise, you will use the following data:

     ~phr_xs_melbourne.tif~

     1. Open the image in *Monteverdi*.
     2. Find the /BandMath/ module in the menu. Open the image in
        this module. What kind of processing is offered ?
     3. Using this module, compute the NDVI of the image: 
        #+LATEX:\begin{equation}
        NDVI = \frac{NIR-RED}{NIR+RED}
        #+LATEX:\end{equation}
     
     Visualize the input image and the mask in
        the same viewer.
     4. Using this module, build a mask of pixels whose Digital Number (DN) in the NIR
        channel is lower than 150. Visualize the input image and the
        mask in the same viewer.
     5. Using this module, build a mask of pixels whose DN is upper
        than 1000 in all spectral bands. Visualize the input image and
        the mask in the same viewer.
     6. Using the /Concatenate/ module, build a composite RGB image
        with the mask of high values in the red channel, the mask of
        low NIR values in the blue channel and the NDVI in the green
        channel.
     7. Using the /Color Mapping/ Module, build a composite RGB image
        of the NDVI that allows for better image interpretation.

     _Tips and Recommandations:_
     - NDVI values are within -1 and 1, but the range can be much
       more narrow.

**** OTB applications: Graphical and command-line mode

     1. Run the following command:
        : $ otbcli_OrthoRectification
        And then
        : $ otbgui_OrthoRectification
        What do you observe ?
     2. How many *OTB applications* are currently available ?
     3. How can you get help and documentation about applications ?

**** OTB applications: Basic processing
     
     1. Use the *OTB applications* to produce the same results as steps 3 to
        7 as with *Monteverdi* in section [[Monteverdi: basic processing]].

**** Homework
     
     1. How can we load or visualize images directly from command-line
        using *Monteverdi* ?
     2. Is there another way to compute radiometric indices like NDVI
        with the *OTB Applications* ?
     3. Learn about the /Python/ access to *OTB Applications* and
        write a python script performing the same steps as in section
        [[OTB applications: Basic processing]].

*** Solutions                                                     :solutions:

**** Monteverdi: data opening and visualisation

***** Item 3

      To load an image into *Monteverdi* viewer module, you can either:
      - Right-click on the image and select /Display in viewer/,
      - In the menu bar, select /Visualization/Viewer/, select the
        corresponding image and push /Ok/.

      The latter allows to load multiple images into a single viewer.

***** Item 4
      
      The lower left text area displays information on the image and on
      the pixel under the mouse pointer:
      - The current position in image,
      - The image size,
      - The channel displayed,
      - The pixel values,
      - The estimated ground spacing,
      - The geographic position (if available),
      - The current location (if available).

**** Monteverdi: basic processing

***** Item 2

      The *BandMath* module allows to do advanced band calculations
      using the syntax from [[http://muparser.sourceforge.net/][muParser]] .

***** Item 3

      To compute the NDVI, use the following *BandMath* expression:
      : (im1b4-im1b1)/(im1b4+im1b1)

***** Item 4

      To build a mask of pixels whose DN in the NIR channel is lower
      than 150, use the following *BandMath* expression:
      : if(im1b4<150,255,0)

***** Item 5

      To build a mask of pixels whose DN is upper
      than 1000 in all spectral bands, use the following *BandMath*
      expression:
      : if(min(im1b1,im1b2,im1b3,im1b4)>1000,255,0)

***** Item 6

      In the menu bar, select /File/Concatenate images/, and loads the
      three *BandMath* module  outputs. The resulting image can be
      displayed in the viewer and will look like this:

      #+Latex:\vspace{0.5cm}
      #+Latex:\begin{center}
      #+ATTR_LaTeX: width=0.9\textwidth
      [[file:Images/bandmath.png]]
      #+Latex:\end{center}

***** Item 7

      In the menu bar, select /Visualisation/Color Mapping/ and load
      the NDVI output from the *BandMath* module. Set a mapping range
      from -0.2 to 0.7 so as to adapt to NDVI range, and select the /Jet/
      color map. The resulting image can be displayed in the viewer and
      will look like this:

      #+Latex:\vspace{0.5cm}
      #+Latex:\begin{center}
      #+ATTR_LaTeX: width=0.9\textwidth
      [[file:Images/colormapping.png]]
      #+Latex:\end{center}

**** OTB applications: Graphical and command-line mode

***** Item 1
      
      The first command runs the command-line version of the
      *Orthorectification* application, the second one runs the
      graphical version.
      
***** Item 2

      There are 59 applications available in OTB 3.14.1.

***** Item 3

      There are several ways to get help and documentation:
      - Running the command-line version of the application displays a
        short description of the parameters, and also gives a link to
        the documentation on the [[http://www.orfeo-toolbox.org][OTB website]],
      - Running the graphical version of the application shows a
        /Documentation/ tab where extensive documentation of parameters
        can be found.
      - Last, the complete applications documentation can be found in
        the [[http://www.orfeo-toolbox.org/CookBook/][Orfeo ToolBox Cookbook]].

**** OTB applications: Basic processing

***** Item 1
   
      Here is the set of commands to reproduce the processing from
      section [[Monteverdi: basic processing]].

      First, we compute the NDVI with the *BandMath* application:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out ndvi.tif float -exp "(im1b4-im1b1)/(im1b4+im1b1)"

      Then, we compute the mask of pixels whose DN in the NIR channel
      is lower than 150:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out lownir.tif uint8 -exp "if(im1b4<150,255,0)"

      Next, we compute the mask of pixels whose DN is upper
      than 1000 in all spectral bands:

      : $ otbcli_BandMath -il phr_xs_melbourne.tif
      :   -out high.tif uint8 
      :   -exp "if(min(im1b1,im1b2,im1b3,im1b4)>1000,255,0)"

      Please note that for masks using a /uint8/ data type is enough,
      while for NDVI a floating point data type is needed.
      
      Now, we can concatenate all outputs in a single map with the
      *ConcatenateImages* application:

      : $ otbcli_ConcatenateImages -il high.tif ndvi.tif lownir.tif 
      :   -out map1.tif float

      Finally, we can create a color-mapping of the NDVI using the
      *ColorMapping* application:

      : $ otbcli_ColorMapping -in ndvi.tif -out map2.png uint8 
      :   -method continuous -method.continuous.min -0.2 
      :   -method.continuous.max 0.7 -method.continuous.lut jet

**** Homework
***** Item 1
      From the command-line, running 
      : $ monteverdi -in  phr_xs_melbourne.tif
      will open the image in *Monteverdi* and display it in the viewer,
      and
      : $ monteverdi -il  phr_xs_melbourne.tif ndvi.tif
      allows to open a list of images in *Monteverdi*.

***** Item 2
      In *OTB Applications*, there is a *RadiometricVegetationIndices*
      application that allows to compute several indices including the
      NDVI.

***** Item 3

      Please refer to this chapter of the *Cookbook* to learn more
      about the /Python/ [[http://www.orfeo-toolbox.org/CookBook/CookBooksu7.html#x16-170001.3.4][interface]].
     
